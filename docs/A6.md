## A6: Indexes, triggers, user functions, transactions and population

This artefact contains: 
- the physical schema of the database;
- the identification and characterisation of the indexes
- the support of data integrity rules with triggers
- the definition of the database user-defined functions
- the database's workload
- the complete database creation script, including all SQL necessary to define all integrity constraints, indexes and triggers
  
This artefact shows the database transactions needed to assure the integrity of the data in the presence of concurrent accesses.

For each transaction, the isolation level is explicitly stated and justified and read-only transactions to improve global performance are identified and justified. This artefact also contains the database's workload as well as the complete database creation script, 

### 1. Database Workload 
#### 1.1. Tuple Estimation

| **Relation reference** | **Relation Name** | **Order of magnitude** | **Estimated growth** |
| ------------------ | ------------- | ------------------------- | -------- |
| R01                | users | thousands | units per day
| R02                | follow | tens of thousands | hundreds per day
| R03                | ban | hundreds | units per week
| R04                | content | hundreds of thousands | thousands per day
| R05                | tag | hundreds | hundreds per day
| R06                | news | thousands | hundreds per day
| R07                | news_tag | units | dozens per day
| R08                | comment | hundreds of thousands | thousands per day
| R09                | request | thousands | dozens per day
| R10                | report_users | hundreds | units per day
| R11                | report_content | thousands | dozens per day 
| R12                | partner_request | dozens | units per week   
| R13                | unban_appeal | hundreds | units per week
| R14                | vote | millions | thousand per day
| R15                | follow_notification | tens of thousands | hundreds per day
| R16                | vote_notification | millions | thousand per day
| R17                | comment_notification | hundreds of thousands | thousands per day
| R18                | faq | dozens | units per month



#### 1.2. Frequent Queries

| **Query**       | SELECT01 |
| ---             | --- |
| **Description** | Display one specific News Post |
| **Frequency**   |  per day |
```sql
    SELECT n.title, n.image, c.nr_votes, n.nr_comments, c.body, c.date, u.username, u.is_partner, u.is_deleted, u.is_banned
    FROM news n, content c, users u
    WHERE n.content_id = $id 
        AND n.content_id = c.id
        AND c.author_id = u.id;          
```

| **Query**       | SELECT02 |
| ---             | --- |
| **Description** | Get comments from Post |
| **Frequency**   |  per day |
```sql
    //SELECT cm.content_id, ct.body, ct.date, ct.nr_votes, u.username, u.is_partner, u.is_deleted, u.is_banned, cm.reply_to_id
    //FROM news n, comment cm, content ct, users u
    //WHERE n.content_id = $id 
    //    AND cm.news_id = n.content_id
    //    AND ct.author_id = u.id;

    WITH RECURSIVE get_comments(id, body, date, nr_votes, username, is_partner, is_deleted, reply_to_id, depth) AS (
            SELECT cm.content_id, ct.body, ct.date, ct.nr_votes, u.username, u.is_partner, u.is_deleted, u.is_banned, cm.reply_to_id, 0
            FROM news n, comment cm, content ct, users u
            WHERE n.content_id = $id 
                AND cm.news_id = n.content_id
                AND ct.author_id = u.id
                AND cm.reply_to_id IS NULL
        UNION ALL
            SELECT cm.content_id, ct.body, ct.date, ct.nr_votes, u.username, u.is_partner, u.is_deleted, u.is_banned, cm.reply_to_id, gc.depth + 1
            FROM news n, comment cm, content ct, users u, get_comments gc
            WHERE n.content_id = $id 
                AND cm.news_id = n.content_id
                AND ct.author_id = u.id
                AND cm.reply_to_id = gc.content_id
    )
    SELECT * from get_comments;
```

| **Query**       | SELECT03 |
| ---             | --- |
| **Description** | Tags from Post |
| **Frequency**   |  per day |
```sql
    SELECT tag.name
    FROM news, news_tag, tag
    WHERE news.id = $id 
        AND news_tag.news_id = news.id
        AND tag.id = news_tag.tag_id;      
```

| **Query**       | SELECT04 |
| ---             | --- |
| **Description** | Get trending news |
| **Frequency**   |  per day |
```sql
    SELECT n.content_id, n.title, n.image, c.date, u.username, u.is_partner
    FROM news n, content c, users u
    WHERE n.content_id = c.id
        AND c.author_id = u.id
        AND u.is_deleted = 'false'
        AND u.is_banned = 'false'
    ORDER BY n.trending_score DESC
    LIMIT 25        
    OFFSET $offset;
```

| **Query**       | SELECT05 |
| ---             | --- |
| **Description** | Get all recent news |
| **Frequency**   |  per day |
```sql
    SELECT n.content_id, n.title, n.image, c.nr_votes, n.nr_comments, c.body, c.date, u.username, u.is_partner
    FROM news n, content c, users u
    WHERE n.content_id = c.id
        AND c.author_id = u.id
        AND u.is_deleted = 'false'
        AND u.is_banned = 'false'
    ORDER BY c.date DESC
    LIMIT 25     
    OFFSET $offset;
```

| **Query**       | SELECT06 |
| ---             | --- |
| **Description** | Get recent news from users I follow |
| **Frequency**   |  per day |
```sql
    SELECT n.content_id, n.title, n.image, c.date, c.body, c.nr_votes, u.username, u.is_partner
    FROM news n, content c, users u
    WHERE n.content_id = c.id
        AND c.author_id = u.id
        AND u.is_deleted = 'false'
        AND u.is_banned = 'false'
        AND c.author_id IN (SELECT f.users_id FROM follow f WHERE f.follower_id = $my_users_id)
    ORDER BY c.date DESC
    LIMIT 25     
    OFFSET $offset;
```

| **Query**       | SELECT07 |
| ---             | --- |
| **Description** | User Profile |
| **Frequency**   |  per day |
```sql
    SELECT u.username, u.description, u.photo, u.is_deleted, u.is_banned, u.reputation, u.is_partner, u.is_moderator
    FROM users u
    WHERE u.id = $users_id;     
```

| **Query**       | SELECT07 |
| ---             | --- |
| **Description** | See edit user profile page |
| **Frequency**   |  per day |
```sql
    SELECT u.username, u.description, u.photo, u.email, u.birthdate, u.gender, u.is_deleted, u.is_banned, u.reputation, u.is_partner, u.is_moderator
    FROM users u
    WHERE u.id = $users_id;     
```


| **Query**       | SELECT08 |
| ---             | --- |
| **Description** | User Posts by date |
| **Frequency**   |  per day |
```sql
    SELECT n.content_id, n.title, n.image, c.nr_votes, n.nr_comments, c.body, c.date 
    FROM users u, content c, news n
    WHERE u.id = $users_id 
        AND c.author_id = u.id
        AND n.content_id = c.id;
    ORDER BY c.date DESC
    LIMIT 25     
    OFFSET $offset;
```


| **Query**       | SELECT09 |
| ---             | --- |
| **Description** | User Posts by trending |
| **Frequency**   |  per day |
```sql
    SELECT news.content_id, news.title, news.image, content.nr_votes, news.nr_comments, content.body, content.date 
    FROM users, content, news
    WHERE users.id = $users_id 
        AND content.author_id = users.id
        AND news.content_id = content.id;
    ORDER BY news.trending_score DESC
    LIMIT 25    
    OFFSET $offset;
```


| **Query**       | SELECT10 |
| ---             | --- |
| **Description** | User Posts by nr_votes |
| **Frequency**   |  per day |
```sql
    SELECT news.content_id, news.title, news.image, content.nr_votes, news.nr_comments, content.body, content.date 
    FROM users, content, news
    WHERE users.id = $users_id 
        AND content.author_id = users.id
        AND news.content_id = content.id;
    ORDER BY content.nr_votes DESC
    LIMIT 25    
    OFFSET $offset;
```


| **Query**       | SELECT11 |
| ---             | --- |
| **Description** | Users I follow |
| **Frequency**   |  per day |
```sql
    SELECT u.id, u.username, u.is_partner, u.photo, u.reputation, u.is_banned, u.is_deleted
    FROM users u
    WHERE u.id IN (SELECT f.users_id FROM follow f WHERE f.follower_id = $my_users_id);  
```


| **Query**       | SELECT12 |
| ---             | --- |
| **Description** | User notifications |
| **Frequency**   |  per day |
```sql
    SELECT n.users_id, n.is_new, n.creation_date
    FROM follow_notification n
    WHERE n.follower_id = $my_users_id
    ORDER BY n.creation_date DESC;

    SELECT n.voter_id, n.content_id, n.is_new, n.creation_date
    FROM vote_notification n
    WHERE n.author_id = $my_users_id
    ORDER BY n.creation_date DESC;   
    
    SELECT n.comment_id, n.is_new, n.creation_date
    FROM comment_notification n
    WHERE n.users_id = $my_users_id
    ORDER BY n.creation_date DESC;
```


| **Query**       | SELECT13 |
| ---             | --- |
| **Description** | Moderator notifications |
| **Frequency**   |  per day |
```sql
    SELECT r.id, r.from_id, r.moderator_id, r.reason, r.crestion_date, r.status, r.revision_date, ru.to_users_id, rc.to_content_id, ua.ban_id
    FROM request r, report_users ru, report_content rc, unban_appeal ua
    WHERE r.id = ru.request_id
        OR r.id = rc.request_id
        OR r.id = ua.request_id
    ORDER BY r.revision_date DESC NULLS FIRST, r.creation_date DESC;
```


| **Query**       | SELECT14 |
| ---             | --- |
| **Description** | FAQ |
| **Frequency**   |  per day |
```sql
   SELECT *
   FROM faq;
```


| **Query**       | SELECT15 |
| ---             | --- |
| **Description** | Search news |
| **Frequency**   |  per day |
```sql
    SELECT n.content_id, n.title, n.image, c.nr_votes, n.nr_comments, c.body, c.date, u.username, u.is_partner
    FROM news n, content c, users u
    WHERE n.search @@ websearch_to_tsquery('english', $search_term)
        AND n.content_id = c.id
        AND c.author_id = u.id
        AND u.is_deleted = 'false'
        AND u.is_banned = 'false'
    ORDER BY ts_rank(n.search, websearch_to_tsquery('english', $serach_term)) DESC
    LIMIT 25
    OFFSET $offset;
```


| **Query**       | SELECT16 |
| ---             | --- |
| **Description** | Search users |
| **Frequency**   |  per day |
```sql
    SELECT u.id, u.username, u.is_partner, u.photo, u.reputation
    FROM users u
    WHERE u.search @@ websearch_to_tsquery('english', $search_term)
        AND u.is_deleted = 'false'
        AND u.is_banned = 'false'
    ORDER BY ts_rank(u.search, websearch_to_tsquery('english', $serach_term)) DESC
    LIMIT 25
    OFFSET $offset; 
```

#### 1.3. Frequent Changes

| **Query**       | UPDATE01                               |
| ---             | ---                                    |
| **Description** | Update User Information |
| **Frequency**   | dozens per day                     |
```sql
UPDATE users,
SET username = $username, email = $email, description = $description, photo = $photo, birthdate = $birthdate, gender = $gender
WHERE id = $id;
```

| **Query**       | UPDATE02                               |
| ---             | ---                                    |
| **Description** | Update User Password |
| **Frequency**   | dozens per day                     |
```sql
UPDATE users,
SET password = $password
WHERE id = $id;
```

| **Query**       | UPDATE03                               |
| ---             | ---                                    |
| **Description** | Update News |
| **Frequency**   | dozens per day                     |
```sql
UPDATE news, content
SET news.title = $title, news.image = $image, content.body = $body
WHERE news.content_id = $content_id
    AND news.content_id = content.id;
```

| **Query**       | UPDATE04                               |
| ---             | ---                                    |
| **Description** | Update Comment |
| **Frequency**   | dozens per day                     |
```sql
UPDATE content
SET body = $body
WHERE content.author_id = $id;
```

| **Query**       | UPDATE05                               |
| ---             | ---                                    |
| **Description** | Update FAQ |
| **Frequency**   | units per month                   |
```sql
UPDATE faq
SET question = $question, answer = $answer
WHERE id = $id;
```

| **Query**       | UPDATE06                               |
| ---             | ---                                    |
| **Description** | Update ban end_date |
| **Frequency**   | units per month                   |
```sql
UPDATE ban
SET end_date = $new_date
WHERE users_id = $id;
```

| **Query**       | UPDATE07                               |
| ---             | ---                                    |
| **Description** | Request revision |
| **Frequency**   | units per month                   |
```sql
UPDATE request
SET moderator_id = $my_id, status = $status, revision_date = NOW()
WHERE id = $request_id;
```

| **Query**       | UPDATE08                               |
| ---             | ---                                    |
| **Description** | See follow notification |
| **Frequency**   | dozens per day                   |
```sql
UPDATE follow_notification
SET is_new = 'false'
WHERE follower_id = $follower_id AND users_id = $users_id;
```

| **Query**       | UPDATE09                               |
| ---             | ---                                    |
| **Description** | See vote notification |
| **Frequency**   | dozens per day                   |
```sql
UPDATE vote_notification
SET is_new = 'false'
WHERE voter_id = $voter_id AND content_id = $content_id AND author_id = $author_id;
```

| **Query**       | UPDATE10                               |
| ---             | ---                                    |
| **Description** | See comment notification |
| **Frequency**   | dozens per day                   |
```sql
UPDATE comment_notification
SET is_new = 'false'
WHERE users_id = $users_id AND comment_id = $comment_id;
```

| **Query**       | UPDATE11                               |
| ---             | ---                                    |
| **Description** | Change delete attribute |
| **Frequency**   | dozens per day                   |
```sql
UPDATE users
SET is_deleted = NOT is_deleted
WHERE id = $id
```

| **Query**       | UPDATE12                               |
| ---             | ---                                    |
| **Description** | Change partner attribute |
| **Frequency**   | dozens per day                   |
```sql
UPDATE users
SET is_partner = NOT is_partner
WHERE id = $id
```

| **Query**       | UPDATE13                               |
| ---             | ---                                    |
| **Description** | Change moderator attribute |
| **Frequency**   | dozens per day                   |
```sql
UPDATE users
SET is_moderator = NOT is_moderator
WHERE id = $id
```


| **Query**       | INSERT01                              |
| ---             | ---                                    |
| **Description** | New User Registered |
| **Frequency**   | units per day                    |
```sql
INSERT INTO users 
    VALUES (NULL, $username, $email, $password, $description, $photo, $birthdate, $gender, NULL, NULL, NULL, NULL, NULL, NULL); 
```

| **Query**       | INSERT02                              |
| ---             | ---                                    |
| **Description** | Add Follow |
| **Frequency**   | units per week                      |
```sql
INSERT INTO follow
    VALUES ($follower_id, $users_id);
```

| **Query**       | INSERT03                              |
| ---             | ---                                    |
| **Description** | Add a Banned User |
| **Frequency**   | units per week                      |
```sql
INSERT INTO ban
    VALUES (NULL, $users_id, $moderator_id, NULL, $end_date, $reason);
```


| **Query**       | INSERT04                              |
| ---             | ---                                    |
| **Description** | Add new Tag |
| **Frequency**   | thousands per day                     |
```sql
INSERT INTO tag
    VALUES (NULL, $name);
```


| **Query**       | INSERT05                              |
| ---             | ---                                    |
| **Description** | Add a Tag to a News Post |
| **Frequency**   | thousands per day                     |
```sql
INSERT INTO news_tag
    VALUES ($news_id, $tags_id);
```


| **Query**       | INSERT06                              |
| ---             | ---                                    |
| **Description** | Vote|
| **Frequency**   | units per week                      |
```sql
INSERT INTO vote
    VALUES ($users_id, $content_id, $value);
```


| **Query**       | INSERT07                              |
| ---             | ---                                    |
| **Description** | Add new FAQ question and answer |
| **Frequency**   | units per week                      |
```sql
INSERT INTO faq
    VALUES (NULL, $question, $answer);
```

| **Query**       | DELETE01                              |
| ---             | ---                                    |
| **Description** | Unfollow  |
| **Frequency**   | units per day                      |
```sql
DELETE FROM follow
WHERE follower_id = $follower_id AND users_id = $userds_id;
```

| **Query**       | DELETE02                              |
| ---             | ---                                    |
| **Description** | Delete Content (comment/news) |
| **Frequency**   | units per day                      |
```sql
DELETE FROM content
WHERE id = $id;
```

| **Query**       | DELETE03                              |
| ---             | ---                                    |
| **Description** | Remove tag from a news post |
| **Frequency**   | units per day                      |
```sql
DELETE FROM news_tag
WHERE news_id = $news_id AND tag_id = $tag_id;
```

| **Query**       | DELETE04                              |
| ---             | ---                                    |
| **Description** | Remove Vote |
| **Frequency**   | units per day                      |
```sql
DELETE FROM vote
WHERE users_id = $users_id AND content_id = $content_id;
```

| **Query**       | DELETE05                              |
| ---             | ---                                    |
| **Description** | Delete FAQ Question and Answer |
| **Frequency**   | units per day                      |
```sql
DELETE FROM faq
WHERE id = $id;
```

| **Query**       | DELETE06                              |
| ---             | ---                                    |
| **Description** | Delete follow notification |
| **Frequency**   | units per day                      |
```sql
DELETE FROM follow_notification
WHERE follower_id = $follower_id AND users_id = $users_id;
```

| **Query**       | DELETE07                              |
| ---             | ---                                    |
| **Description** | Delete vote notification |
| **Frequency**   | units per day                      |
```sql
DELETE FROM vote_notification
WHERE voter_id = $voter_id AND content_id = $content_id AND author_id = $author_id;
```

| **Query**       | DELETE08                              |
| ---             | ---                                    |
| **Description** | Delete comment notification |
| **Frequency**   | units per day                      |
```sql
DELETE FROM comment_notification
WHERE users_id = $users_id AND comment_id = $comment_id;
```

### 2. Proposed Indices

#### 2.1. Performance Indices

> Indices proposed to improve performance of the identified queries.  

| **Index**           | IDX01                                  |
| ---                 | ---                                    |
| **Related queries** | SELECT01, ...                          |
| **Relation**        | Relation where the index is applied    |
| **Attribute**       | Attribute where the index is applied   |
| **Type**            | B-tree, Hash, GiST or GIN              |
| **Cardinality**     | Attribute cardinality: low/medium/high |
| **Clustering**      | Clustering of the index                |
| **Justification**   | Justification for the proposed index   |
| `SQL code`                                                  ||
 
#### 2.2. Full-text Search Indices 

> The system being developed must provide full-text search features supported by PostgreSQL. Thus, it is necessary to specify the fields where full-text search will be available and the associated setup, namely all necessary configurations, indexes definitions and other relevant details.  

| **Index**           | IDX01                                  |
| ---                 | ---                                    |
| **Related queries** | SELECT01, ...                          |
| **Relation**        | news |
| **Attribute**       | search |
| **Type**            | GIST |
| **Clustering**      | No |
| **Justification**   | Used to improve performance of full text searches when searching for news, gist because news is dynamic data |
 ```sql
ALTER TABLE news ADD COLUMN search TS_VECTOR;
CREATE INDEX search_news_idx ON news USING GIST (search);
 ```
 
| **Index**           | IDX02                                  |
| ---                 | ---                                    |
| **Related queries** | SELECT01, ...                          |
| **Relation**        | users    |
| **Attribute**       | search   |
| **Type**            | GIT |
| **Clustering**      | No |
| **Justification**   | Used to improve performance of full text searches when searching for users, git because users data is rarely changed. |
 ```sql
ALTER TABLE users ADD COLUMN search TS_VECTOR;
CREATE INDEX search_users_idx ON users USING GIT (search);
 ```

### 3. Triggers
 
> User-defined functions and trigger procedures that add control structures to the SQL language or perform complex computations, are identified and described to be trusted by the database server. Every kind of function (SQL functions, Stored proc edures, Trigger procedures) can take base types, composite types, or combinations of these as arguments (parameters). In addition, every kind of function can return a base type or a composite type. Functions can also be defined to return sets of base or composite values.  

| **Trigger**      | TRIGGER01                              |
| ---              | ---                                    |
| **Description**  | Ensure that only moderators can approve / reject requests |
 ```sql
CREATE OR REPLACE FUNCTION action_is_from_moderator() RETURNS TRIGGER AS
    $BODY$
        BEGIN
            IF ((SELECT COUNT(*) FROM users WHERE users.id = New.moderator_id) <> 1)
                THEN RAISE EXCEPTION 'There must be a moderator to update a request status.';
            END IF;
            RETURN NEW;
        END
    $BODY$
LANGUAGE plpgsql;

CREATE TRIGGER trigger_is_from_moderator
    BEFORE UPDATE OF status ON request
    FOR EACH ROW
    EXECUTE PROCEDURE action_is_from_moderator();
 ```

| **Trigger**      | TRIGGER02                             |
| ---              | ---                                    |
| **Description**  | Ensure that every request must belong to only one generalization |
 ```sql
CREATE OR REPLACE FUNCTION action_disjoint_request() RETURNS TRIGGER AS $$
BEGIN
    IF TG_OP = 'INSERT' THEN
        IF ((SELECT COUNT(*) FROM partner_request, unban_appeal, report_user, report_content WHERE ((partner_request.request_id = New.request_id)OR(unban_appeal.request_id = New.request_id)OR(report_user.request_id = New.request_id)OR(report_content.request_id = New.request_id))) <> 0)
			THEN RAISE EXCEPTION 'A request must belong to a single table.';
		END IF;
    END IF;
    IF TG_OP = 'UPDATE' THEN
        IF ((SELECT COUNT(*) FROM partner_request, unban_appeal, report_user, report_content WHERE ((partner_request.request_id = New.request_id)OR(unban_appeal.request_id = New.request_id)OR(report_user.request_id = New.request_id)OR(report_content.request_id = New.request_id))) <> 1)
			THEN RAISE EXCEPTION 'A request must belong to a single table.';
		END IF;
    END IF;
    RETURN NEW;
END
$$ LANGUAGE plpgsql;

DO $$
DECLARE
    t text;
BEGIN
    FOR t IN
        SELECT table_name FROM information_schema.columns WHERE column_name = 'request_id'
    LOOP
        EXECUTE format('CREATE TRIGGER trigger_disjoint_request
                    BEFORE INSERT OR UPDATE ON %I
                    FOR EACH ROW EXECUTE PROCEDURE action_disjoint_request()', t, t);
    END loop;
END;
$$ language 'plpgsql';
 ```

### 4. Transactions

| **T01**  | Insert new News Post                   |
| --------------- | ----------------------------------- |
| **Justification**   | In order to maintain consistency, we use a transaction to ensure that the code executes without errors. If an error occurs, a ROLLBACK is issued.  |
| **Isolation level** | Isolation level of the transaction. |
```sql
BEGIN TRANSACTION;
SET TRANSACTION ISOLATION LEVEL REPEATABLE READ 
 
-- Create News' Content
INSERT INTO content (author_id, body, date, nr_votes)
VALUES ($author_id, $body, $date, $nr_votes);

-- Create News
INSERT INTO news (content_id, title, image, trending_score)
VALUES (currval('content_id_seq'), $title, $image, $trending_score);
 
COMMIT;
```

| **T02**  | Insert new Comment                   |
| --------------- | ----------------------------------- |
| **Justification**   | In order to maintain consistency, we use a transaction to ensure that the code executes without errors. If an error occurs, a ROLLBACK is issued.  |
| **Isolation level** | Isolation level of the transaction. |
```sql
BEGIN TRANSACTION;
SET TRANSACTION ISOLATION LEVEL REPEATABLE READ 
 
-- Create News' Content
INSERT INTO content (author_id, body, date, nr_votes)
VALUES ($author_id, $body, $date, $nr_votes);

-- Create Comment
INSERT INTO comment (content_id, news_id, reply_to_id)
VALUES (currval('content_id_seq'), $news_id, $reply_to_id);
 
COMMIT;
```

| **T03**  | Insert new Report User                   |
| --------------- | ----------------------------------- |
| **Justification**   | In order to maintain consistency, we use a transaction to ensure that the code executes without errors. If an error occurs, a ROLLBACK is issued.  |
| **Isolation level** | Isolation level of the transaction. |
```sql
BEGIN TRANSACTION;
SET TRANSACTION ISOLATION LEVEL REPEATABLE READ 
 
-- Create Request
INSERT INTO request (from_id, moderator_id, reason, creation_date, status, revision_date)
VALUES ($from_id, $moderator_id, $reason, $creation_date, $status, $revision_date);

-- Create new Report User
INSERT INTO report_users (request_id, to_users_id)
VALUES (currval('request_id_seq'), $to_users_id);
 
COMMIT;
```

| **T04**  | Insert new Report Content                  |
| --------------- | ----------------------------------- |
| **Justification**   | In order to maintain consistency, we use a transaction to ensure that the code executes without errors. If an error occurs, a ROLLBACK is issued.  |
| **Isolation level** | Isolation level of the transaction. |
```sql
BEGIN TRANSACTION;
SET TRANSACTION ISOLATION LEVEL REPEATABLE READ 
 
-- Create Request
INSERT INTO request (from_id, moderator_id, reason, creation_date, status, revision_date)
VALUES ($from_id, $moderator_id, $reason, $creation_date, $status, $revision_date);

-- Create new Report Content
INSERT INTO report_content (request_id, to_content_id)
VALUES (currval('request_id_seq'), $to_content_id);
 
COMMIT;
```

| **T05**  | Insert new Partner Request                  |
| --------------- | ----------------------------------- |
| **Justification**   | In order to maintain consistency, we use a transaction to ensure that the code executes without errors. If an error occurs, a ROLLBACK is issued.  |
| **Isolation level** | Isolation level of the transaction. |
```sql
BEGIN TRANSACTION;
SET TRANSACTION ISOLATION LEVEL REPEATABLE READ 
 
-- Create Request
INSERT INTO request (from_id, moderator_id, reason, creation_date, status, revision_date)
VALUES ($from_id, $moderator_id, $reason, $creation_date, $status, $revision_date);

-- Create new Report User
INSERT INTO partner_request (request_id)
VALUES (currval('request_id_seq'));
 
COMMIT;
```

| **T06**  | Insert new Unban Appeal                 |
| --------------- | ----------------------------------- |
| **Justification**   | In order to maintain consistency, we use a transaction to ensure that the code executes without errors. If an error occurs, a ROLLBACK is issued.  |
| **Isolation level** | Isolation level of the transaction. |
```sql
BEGIN TRANSACTION;
SET TRANSACTION ISOLATION LEVEL REPEATABLE READ 
 
-- Create Request
INSERT INTO request (from_id, moderator_id, reason, creation_date, status, revision_date)
VALUES ($from_id, $moderator_id, $reason, $creation_date, $status, $revision_date);

-- Create new Report User
INSERT INTO unban_appeal (request_id, ban_id)
VALUES (currval('request_id_seq'), $ban_id);
 
COMMIT;
```
