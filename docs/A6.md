## A6: Indexes, triggers, user functions, transactions and population

This artefact contains: 
- the physical schema of the database;
- the identification and characterisation of the indexes
- the support of data integrity rules with triggers
- the definition of the database user-defined functions
- the database's workload
- the complete database creation script, including all SQL necessary to define all integrity constraints, indexes and triggers
  
This artefact shows the database transactions needed to assure the integrity of the data in the presence of concurrent accesses.

For each transaction, the isolation level is explicitly stated and justified and read-only transactions to improve global performance are identified and justified. This artefact also contains the database's workload as well as the complete database creation script, 

### 1. Database Workload 
#### 1.1. Tuple Estimation

| **Relation reference** | **Relation Name** | **Order of magnitude** | **Estimated growth** |
| ------------------ | ------------- | ------------------------- | -------- |
| R01                | users | thousands | units per day
| R02                | follow | tens of thousands | hundreds per day
| R03                | ban | hundreds | units per week
| R04                | content | hundreds of thousands | thousands per day
| R05                | tag | hundreds | hundreds per day
| R06                | news | thousands | hundreds per day
| R07                | news_tag | units | dozens per day
| R08                | comment | hundreds of thousands | thousands per day
| R09                | request | thousands | dozens per day
| R10                | report_users | hundreds | units per day
| R11                | report_content | thousands | dozens per day 
| R12                | partner_request | dozens | units per week   
| R13                | unban_appeal | hundreds | units per week
| R14                | vote | millions | thousand per day
| R15                | follow_notification | tens of thousands | hundreds per day
| R16                | vote_notification | millions | thousand per day
| R17                | comment_notification | hundreds of thousands | thousands per day
| R18                | faq | dozens | units per month



#### 1.2. Frequent Queries

| **Query**       | SELECT01 |
| ---             | --- |
| **Description** | Display one specific News Post |
| **Frequency**   | Tens of thousands per day |
```sql
    SELECT news.title, news.image, content.nr_votes, news.nr_comments, content.body, content.date, users.username, users.is_partner
    FROM news, content, users
    WHERE news.content_id = $id 
        AND news.content_id = content.id
        AND content.author_id = users.id
        AND users.is_deleted = false;          
```

| **Query**       | SELECT02 |
| ---             | --- |
| **Description** | Get comments from Post |
| **Frequency**   | Tens of thousands per day |
```sql
    SELECT comment.content_id, content.body, content.date, content.nr_votes, users.username, users.is_partner, users.is_deleted, comment.reply_to_id
    FROM news, comment, content, users
    WHERE news.content_id = $id 
        AND comment.news_id = news.content_id
        AND content.author_id = users.id;
```

| **Query**       | SELECT03 |
| ---             | --- |
| **Description** | Tags from Post |
| **Frequency**   | Hundreds of thousands per day |
```sql
    SELECT tag.name
    FROM news, news_tag, tag
    WHERE news.id = $id 
        AND news_tag.news_id = news.id
        AND tag.id = news_tag.tag_id;      
```

| **Query**       | SELECT04 |
| ---             | --- |
| **Description** | Get trending news |
| **Frequency**   | Hundreds of thousands per day |
```sql
    SELECT news.content_id, news.title, news.image, content.date, users.username, user.is_partner
    FROM news, content, users
    WHERE news.content_id = content.id
        AND content.author_id = users.id
        AND users.is_deleted = false
    ORDER BY news.trending_score DESC
    OFFSET $offset
    LIMIT 25;        
```

| **Query**       | SELECT05 |
| ---             | --- |
| **Description** | Get all recent news |
| **Frequency**   | Hundreds of thousands per day |
```sql
    SELECT news.content_id, news.title, news.image, content.nr_votes, news.nr_comments, content.body, content.date, users.username, users.is_partner
    FROM news, content, users
    WHERE news.content_id = content.id
        AND content.author_id = users.id
        AND users.is_deleted = false
    ORDER BY content.date DESC
    OFFSET $offset
    LIMIT 25;        
```

| **Query**       | SELECT01 |
| ---             | --- |
| **Description** | Get recent news for main page when logged in |
| **Frequency**   | Hundreds of thousands per day |
```sql
    SELECT news.content_id, news.title, news.image, content.date, content.body, content.nr_votes, users.username, user.is_partner
    FROM news, content, users
    WHERE news.content_id = content.id
        AND content.author_id = users.id
        AND users.is_deleted = false
        AND content.author_id IN (SELECT follow.users_id FROM follow WHERE follow.follower_id = $my_users_id)
    ORDER BY content.date DESC
    OFFSET $offset
    LIMIT 25;      
```

| **Query**       | SELECT07 |
| ---             | --- |
| **Description** | User Profile |
| **Frequency**   | Hundreds per day |
```sql
    SELECT users.username, users.description, users.photo, users.birthdate, users.gender, users.is_deleted, users.is_banned, users.reputation, users.is_partner, users.is_moderator
    FROM users
    WHERE users.id = $users_id;
          
```

| **Query**       | SELECT08 |
| ---             | --- |
| **Description** | User Posts by date |
| **Frequency**   | Hundreds per day |
```sql
    SELECT news.content_id, news.title, news.image, content.nr_votes, news.nr_comments, content.body, content.date 
    FROM users, content, news
    WHERE users.id = $users_id 
        AND content.author_id = users.id
        AND news.content_id = content.id;
    ORDER BY content.date DESC
    OFFSET $offset
    LIMIT 25;     
```

| **Query**       | SELECT09 |
| ---             | --- |
| **Description** | User Posts by trending |
| **Frequency**   | Hundreds per day |
```sql
    SELECT news.content_id, news.title, news.image, content.nr_votes, news.nr_comments, content.body, content.date 
    FROM users, content, news
    WHERE users.id = $users_id 
        AND content.author_id = users.id
        AND news.content_id = content.id;
    ORDER BY news.trending_score DESC
    OFFSET $offset
    LIMIT 25;     
```

| **Query**       | SELECT10 |
| ---             | --- |
| **Description** | User Posts by nr_votes |
| **Frequency**   | Hundreds per day |
```sql
    SELECT news.content_id, news.title, news.image, content.nr_votes, news.nr_comments, content.body, content.date 
    FROM users, content, news
    WHERE users.id = $users_id 
        AND content.author_id = users.id
        AND news.content_id = content.id;
    ORDER BY content.nr_votes DESC
    OFFSET $offset
    LIMIT 25;     
```

| **Query**       | SELECT10 |
| ---             | --- |
| **Description** | User following |
| **Frequency**   | Hundreds per day |
```sql
    SELECT users.id, users.username, users.is_partner, users.photo, users.reputation
    FROM users
    WHERE users.id IN (SELECT follow.users_id FROM follow WHERE follow.follower_id = $my_users_id);      
```

| **Query**       | SELECT10 |
| ---             | --- |
| **Description** | User notifications |
| **Frequency**   | Hundreds per day |
```sql
    SELECT follow_notification.users_id, follow_notification.is_new, follow_notification.creation_date
    FROM follow_notification
    WHERE follow_notification.follower_id = $my_users_id;

    SELECT follow_notification.users_id, follow_notification.is_new, follow_notification.creation_date
    FROM follow_notification
    WHERE follow_notification.follower_id = $my_users_id;   
```



| **Query**       | SELECT09                               |
| ---             | ---                                    |
| **Description** | Search |
| **Frequency**   | Hundreds per day                     |
```sql
   SELECT news.*, content.body, ts_rank_cd(textsearch, query) AS rank 
   FROM news, content, to_tsquery($search) AS query, to_tsvector(title || ' ' || body) AS textsearch, 
   WHERE query @@ textsearch\\ ORDER BY rank DESC;


   SELECT title
    FROM posts
    WHERE search @@ plainto_tsquery('english', 'jumping dog')
    ORDER BY ts_rank(search, plainto_tsquery('english', 'jumping dog')) DESC
```

#### 1.3. Frequent Updates

| **Query**       | UPDATE01                               |
| ---             | ---                                    |
| **Description** | One sentence describing the query goal |
| **Frequency**   | magnitude per time                     |
| `SQL code`                                              ||

| **Query**       | UPDATE01                               |
| ---             | ---                                    |
| **Description** | Update User Information |
| **Frequency**   | dozens per day                     |
```sql
UPDATE users,
SET username = $username, email = $email, description = $description, photo = $photo, birthdate = $birthdate, gender = $gender
WHERE id = $id;
```

| **Query**       | UPDATE02                               |
| ---             | ---                                    |
| **Description** | Update User Password |
| **Frequency**   | dozens per day                     |
```sql
UPDATE users,
SET password = $password
WHERE id = $id;
```

| **Query**       | UPDATE03                               |
| ---             | ---                                    |
| **Description** | Update News Specific Information |
| **Frequency**   | dozens per day                     |
```sql
UPDATE news, users, content
SET news.title = $title, news.image = $image
WHERE users.id = $id AND content.author_id = users.id AND content.id = news.content_id;
```

| **Query**       | UPDATE04                              |
| ---             | ---                                    |
| **Description** | Update New's Tags |
| **Frequency**   | dozens per day                     |
```sql
UPDATE news, news_tag, content, tag
SET name = $name
WHERE users.id = $id AND content.author_id = users.id AND content.id = news.content_id AND tag.id = news_tag.tag_id AND news_tag.news_id = news.id;
```

| **Query**       | UPDATE05                               |
| ---             | ---                                    |
| **Description** | Update Content (News, Comment) |
| **Frequency**   | dozens per day                     |
```sql
UPDATE users, content
SET body = $body
WHERE users.id = $id AND content.author_id = users.id;
```

| **Query**       | UPDATE06                               |
| ---             | ---                                    |
| **Description** | Update FAQ |
| **Frequency**   | units per month                   |
```sql
UPDATE faq
SET question = $question, answer = $answer
WHERE id = $id;
```

| **Query**       | INSERT01                              |
| ---             | ---                                    |
| **Description** | New User Registered |
| **Frequency**   | units per day                    |
```sql
INSERT INTO users (username, email, password, description, photo, birthdate, gender, reputation, is_mdoerator, is_partner, is_banned, is_deleted) 
VALUES ($username, $email, $password, $description, $photo, $birthdate, $gender, $reputation, $is_mdoerator, $is_partner, $is_banned, $is_deleted); 
```

| **Query**       | INSERT02                              |
| ---             | ---                                    |
| **Description** | Add Follow |
| **Frequency**   | units per week                      |
```sql
INSERT INTO follow (follower_id, users_id)
VALUES ($follower_id, $users_id);
```

| **Query**       | INSERT03                              |
| ---             | ---                                    |
| **Description** | Add a Banned User |
| **Frequency**   | units per week                      |
```sql
INSERT INTO ban (users_id, moderator_id, start_date, end_date, reason)
VALUES ($users_id, $moderator_id, $start_date, $end_date, $reason);
```

| **Query**       | INSERT04                              |
| ---             | ---                                    |
| **Description** | Add Content |
| **Frequency**   | thousands per day                     |
```sql
INSERT INTO content (author_id, body, date, nr_votes)
VALUES ($author_id, $body, $date, $nr_votes);
```

| **Query**       | INSERT05                              |
| ---             | ---                                    |
| **Description** | Add new Tag |
| **Frequency**   | thousands per day                     |
```sql
INSERT INTO tag (name)
VALUES ($name);
```

| **Query**       | INSERT06                              |
| ---             | ---                                    |
| **Description** | Create a News Post |
| **Frequency**   | thousands per day                     |
```sql
INSERT INTO news (content_id, title, image, trending_score)
VALUES ($content_id, $title, $image, $trending_score);
```

| **Query**       | INSERT07                              |
| ---             | ---                                    |
| **Description** | Add a Tag to a News Post |
| **Frequency**   | thousands per day                     |
```sql
INSERT INTO news_tag (news_id, tags_id)
VALUES ($news_id, $tags_id);
```

| **Query**       | INSERT08                              |
| ---             | ---                                    |
| **Description** | Create New Comment |
| **Frequency**   | thousands per day                     |
```sql
INSERT INTO comment (content_id, news_id, reply_to_id)
VALUES ($content_id, $news_id, $reply_to_id);
```

| **Query**       | INSERT09                              |
| ---             | ---                                    |
| **Description** | Make New Request |
| **Frequency**   | dozens per day                      |
```sql
INSERT INTO request (from_id, moderator_id, reason, creation_date, status, revision_date)
VALUES ($from_id, $moderator_id, $reason, $creation_date, $status, $revision_date);
```

| **Query**       | INSERT10                             |
| ---             | ---                                    |
| **Description** | Report User |
| **Frequency**   | units per day                      |
```sql
INSERT INTO report_users (request_id, to_users_id)
VALUES ($request_id, $to_content_id);
```

| **Query**       | INSERT11                              |
| ---             | ---                                    |
| **Description** | Report Content |
| **Frequency**   | dozens per day                      |
```sql
INSERT INTO report_content (request_id, to_content_id)
VALUES ($request_id, $to_content_id);
```

| **Query**       | INSERT12                              |
| ---             | ---                                    |
| **Description** | Make a Partner Request |
| **Frequency**   | units per week                      |
```sql
INSERT INTO partner_request (request_id)
VALUES ($request_id);
```

| **Query**       | INSERT13                              |
| ---             | ---                                    |
| **Description** | Make an Unban Appeal Request |
| **Frequency**   | units per week                      |
```sql
INSERT INTO unban_appeal (request_id, ban_id)
VALUES ($request_id, $ban_id);
```

| **Query**       | INSERT14                              |
| ---             | ---                                    |
| **Description** | Vote|
| **Frequency**   | units per week                      |
```sql
INSERT INTO vote (users_id, content_id)
VALUES ($users_id, $content_id);
```

| **Query**       | INSERT15                              |
| ---             | ---                                    |
| **Description** | Follow Notification |
| **Frequency**   | units per week                      |
```sql
INSERT INTO follow_notification (follower_id, users_id, in_new, creation_date)
VALUES ($follower_id, $users_id, $in_new, $creation_date);
```

| **Query**       | INSERT16                              |
| ---             | ---                                    |
| **Description** | Vote Notification |
| **Frequency**   | units per week                      |
```sql
INSERT INTO vote_notification (voter_id, content_id, author_id, in_new, creation_date)
VALUES ($voter_id, $contens_id, $author_id, $in_new, $creation_date);
```

| **Query**       | INSERT17                              |
| ---             | ---                                    |
| **Description** | Comment Notification |
| **Frequency**   | units per week                      |
```sql
INSERT INTO vote_notification (users_id, comment_id, in_new, creation_date)
VALUES ($users_id, $comment_id, $in_new, $creation_date);
```

| **Query**       | INSERT18                              |
| ---             | ---                                    |
| **Description** | Add new FAQ question and answer |
| **Frequency**   | units per week                      |
```sql
INSERT INTO faq(question, answer)
VALUES ($question, $answer);
```

| **Query**       | DELETE01                              |
| ---             | ---                                    |
| **Description** | Unfollow  |
| **Frequency**   | units per day                      |
```sql
DELETE FROM follow
WHERE follower_id = $follower_id AND users_id = $userds_id;
```

| **Query**       | DELETE02                              |
| ---             | ---                                    |
| **Description** | Delete Content |
| **Frequency**   | units per day                      |
```sql
DELETE FROM content
WHERE id = $id;
```

| **Query**       | DELETE03                              |
| ---             | ---                                    |
| **Description** | Delete Tag Associated to a News Post |
| **Frequency**   | units per day                      |
```sql
DELETE FROM news_tag
WHERE news_id = $news_id AND tag_id = $tag_id;
```

| **Query**       | DELETE04                              |
| ---             | ---                                    |
| **Description** | Erase Vote |
| **Frequency**   | units per day                      |
```sql
DELETE FROM vote
WHERE users_id = $users_id AND content_id = $content_id;
```

| **Query**       | DELETE05                              |
| ---             | ---                                    |
| **Description** | Delete FAQ Question and Answer |
| **Frequency**   | units per day                      |
```sql
DELETE FROM faq
WHERE id = $id;
```

### 2. Proposed Indices

#### 2.1. Performance Indices

> Indices proposed to improve performance of the identified queries.  

| **Index**           | IDX01                                  |
| ---                 | ---                                    |
| **Related queries** | SELECT01, ...                          |
| **Relation**        | Relation where the index is applied    |
| **Attribute**       | Attribute where the index is applied   |
| **Type**            | B-tree, Hash, GiST or GIN              |
| **Cardinality**     | Attribute cardinality: low/medium/high |
| **Clustering**      | Clustering of the index                |
| **Justification**   | Justification for the proposed index   |
| `SQL code`                                                  ||
 
#### 2.2. Full-text Search Indices 

> The system being developed must provide full-text search features supported by PostgreSQL. Thus, it is necessary to specify the fields where full-text search will be available and the associated setup, namely all necessary configurations, indexes definitions and other relevant details.  

| **Index**           | IDX01                                  |
| ---                 | ---                                    |
| **Related queries** | SELECT01, ...                          |
| **Relation**        | news |
| **Attribute**       | search |
| **Type**            | GiST |
| **Clustering**      | No |
| **Justification**   | Used to improve performance of full text searches when searching for news, gist because news is dynamic data |
 ```sql
ALTER TABLE news ADD COLUMN search TS_VECTOR;
CREATE INDEX search_news_idx ON news USING GIST (search);
 ```
 
| **Index**           | IDX02                                  |
| ---                 | ---                                    |
| **Related queries** | SELECT01, ...                          |
| **Relation**        | Relation where the index is applied    |
| **Attribute**       | Attribute where the index is applied   |
| **Type**            | GiST |
| **Clustering**      | No |
| **Justification**   | Used to improve performance of full text searches when searching for users, gist because users is dynamic data |
 ```sql
ALTER TABLE users ADD COLUMN search TS_VECTOR;
CREATE INDEX search_users_idx ON users USING GIST (search);
 ```

### 3. Triggers
 
> User-defined functions and trigger procedures that add control structures to the SQL language or perform complex computations, are identified and described to be trusted by the database server. Every kind of function (SQL functions, Stored proc edures, Trigger procedures) can take base types, composite types, or combinations of these as arguments (parameters). In addition, every kind of function can return a base type or a composite type. Functions can also be defined to return sets of base or composite values.  

| **Trigger**      | TRIGGER01                              |
| ---              | ---                                    |
| **Description**  | Ensure that only moderators can approve / reject requests |
 ```sql
CREATE OR REPLACE FUNCTION action_is_from_moderator() RETURNS TRIGGER AS
    $BODY$
        BEGIN
            IF ((SELECT COUNT(*) FROM users WHERE users.id = New.moderator_id) <> 1)
                THEN RAISE EXCEPTION 'There must be a moderator to update a request status.';
            END IF;
            RETURN NEW;
        END
    $BODY$
LANGUAGE plpgsql;

CREATE TRIGGER trigger_is_from_moderator
    BEFORE UPDATE OF status ON request
    FOR EACH ROW
    EXECUTE PROCEDURE action_is_from_moderator();
 ```

| **Trigger**      | TRIGGER02                             |
| ---              | ---                                    |
| **Description**  | Ensure that every request must belong to only one generalization |
 ```sql
CREATE OR REPLACE FUNCTION action_disjoint_request() RETURNS TRIGGER AS $$
BEGIN
    IF TG_OP = 'INSERT' THEN
        IF ((SELECT COUNT(*) FROM partner_request, unban_appeal, report_user, report_content WHERE ((partner_request.request_id = New.request_id)OR(unban_appeal.request_id = New.request_id)OR(report_user.request_id = New.request_id)OR(report_content.request_id = New.request_id))) <> 0)
			THEN RAISE EXCEPTION 'A request must belong to a single table.';
		END IF;
    END IF;
    IF TG_OP = 'UPDATE' THEN
        IF ((SELECT COUNT(*) FROM partner_request, unban_appeal, report_user, report_content WHERE ((partner_request.request_id = New.request_id)OR(unban_appeal.request_id = New.request_id)OR(report_user.request_id = New.request_id)OR(report_content.request_id = New.request_id))) <> 1)
			THEN RAISE EXCEPTION 'A request must belong to a single table.';
		END IF;
    END IF;
    RETURN NEW;
END
$$ LANGUAGE plpgsql;

DO $$
DECLARE
    t text;
BEGIN
    FOR t IN
        SELECT table_name FROM information_schema.columns WHERE column_name = 'request_id'
    LOOP
        EXECUTE format('CREATE TRIGGER trigger_disjoint_request
                    BEFORE INSERT OR UPDATE ON %I
                    FOR EACH ROW EXECUTE PROCEDURE action_disjoint_request()', t, t);
    END loop;
END;
$$ language 'plpgsql';
 ```

### 4. Transactions
 
> Transactions needed to assure the integrity of the data.  

| SQL Reference   | Transaction Name                    |
| --------------- | ----------------------------------- |
| Justification   | Justification for the transaction.  |
| Isolation level | Isolation level of the transaction. |
| `Complete SQL Code`                                   ||
