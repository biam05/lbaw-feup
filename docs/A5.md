## A5: Relational Schema, validation and schema refinement

The artifact presented in this section contains the Relational Schema obtained by mapping from the Conceptual Data Model (A4). 

### 1. Relational Schema

| Relation reference | Relation Compact Notation                        |
| ------------------ | ------------------------------------------------ |
| R01                | user(**id**, username UK NN, email UK NN, password, description, photo UK, birthdate NN CK years(TODAY - birthdate) >= 13, gender NN CK gender IN GENDER_TYPE, reputation NN DF 0 CK reputation >= 0, is_moderator NN DF false, is_partner NN DF false, is_banned NN DF false,is_deleted NN DF false) |
| R02                | follow(**follower_id** → user NN, **user_id** → user NN)
| R03                | ban(**id**, user_id → user NN, moderator_id → moderator, start NN DF TODAY, end DF NULL CK end > start, reason NN) |
| R04                | content(**id**, author_id → user, body NN, date NN DF TODAY, nr_votes NN DF 0) |  
| R05                | tag(**id**, name NN UK) |
| R06                | news(**content_id** → content, title NN, image UK, trending_score NN CK trending_score >= 0) |
| R07                | news_tag(**news_id** → news NN, **tag_id** → tag NN ) |
| R08                | comment(**content_id** → content, news_id → news NN, reply_to_id → comment) |
| R09                | request(**id**, from_id → user NN, moderator_id → user, reason NN, creation_date NN DF TODAY, status CK status IN STATUS_TYPE, revision_date CK revision_date > creation_date) |
| R10                | report_user(**request_id** → request, to_user_id → user NN) |
| R11                | report_content(**request_id** → request, to_content_id → content NN) |
| R12                | partner_request(**request_id** → request) |
| R13                | unban_appeal(**request_id** → request, ban_id → ban NN) |
| R14                | vote(**user_id** → user, **content_id** → content, value NN) |
| R15                | follow_notification(**follower_id** → user NN, **user_id** → vote, is_new DF true, date DF TODAY) |
| R16                | vote_notification(**voter_id** → user, **content_id** → content, **author_id** → user NN, is_new DF true, date DF TODAY) |
| R17                | comment_notification(**user_id** → user, **comment_id** → comment, is_new DF true, date DF TODAY) |
| R18                | faq(**id**, question NN UK, answer NN) |

where UK means UNIQUE KEY, NN means NOT NULL, DF means DEFAULT and CK means CHECK.

#### 1.1 Generalizations
- **Content Generalization**: Subclasses point to the Superclass → the Content table has too many relations with other classes.
- **Request Generalization**: Subclasses point to the Superclass → each subclass will have different relations.
- **User Generalization**: One relation with all the attributes of all the classes → good approach for a heavily overlapping generalization with a small number of subclasses
- **Report Generalization**: Only subclasses are represented → there is no internal information stored in this classes, only external connections.
- **Notification Generalization**: Only subclasses are represented → it is a disjoint generalization and the few information that belongs to the superclass will be accessed every time we access the subclasses.

### 2. Domains

Specification of additional domains:  

| Domain Name  | Domain Specification        |
| ------------ | --------------------------- |
| GENDER_TYPE  | ENUM('m','f','n')           |
| TODAY        | DATE DEFAULT CURRENT_DATE   |
| STATUS_TYPE  | ENUM('aproved', 'rejected') |


### 3. Schema validation

| **TABLE R01**   | user |
| --------------  | ---- |
| **Keys**        | {id}, {email}, {username}, {photo} |
| **Functional Dependencies:** |
| FD0101          | id → {username, email, password, description, photo, birthdate, gender, reputation, is_moderator, is_partner, is_banned, is_deleted} |
| FD0102          | username → {id, email, password, description, photo, birthdate, gender, reputation, is_moderator, is_partner, is_banned, is_deleted} |
| FD0103          | email → {id, username, password, description, photo, birthdate, gender, reputation, is_moderator, is_partner, is_banned, is_deleted} |
| FD0104          | photo → {id, email, username, password, description, birthdate, gender, reputation, is_moderator, is_partner, is_banned, is_deleted} |
| **NORMAL FORM** | BCNF |

| **TABLE R02**   | follow |
| --------------  | --- |
| **Keys**        | {follower_id, user_id} |
| **Functional Dependencies:** |
| (none) | |
| **NORMAL FORM** | BCNF |

| **TABLE R05**   | ban |
| --------------  | --- |
| **Keys**        | {id} |
| **Functional Dependencies:** |
| FD0501          | id → {user_id, moderator_id, start, end, reason} |
| **NORMAL FORM** | BCNF |

| **TABLE R04**   | content |
| --------------  | --- |
| **Keys**        | {id} |
| **Functional Dependencies:** |
| FD01701          | id → {author_id, body, date} |
| **NORMAL FORM** | BCNF |

| **TABLE R06**   | tag |
| --------------  | --- |
| **Keys**        | {id}, {name} |
| **Functional Dependencies:** |
| FD01101         | id → {name} |
| FD01101         | name → {id} |
| **NORMAL FORM** | BCNF |

| **TABLE R07**   | news |
| --------------  | ---- |
| **Keys**        | {id} |
| **Functional Dependencies:** |
| FD0901          | id → {content_id, title, image, trending_score} |
| **NORMAL FORM** | BCNF |

| **TABLE R08**   | news_tag |
| --------------  | --- |
| **Keys**        | {id} |
| **Functional Dependencies:** |
| FD01201          | id → {news_id, tag_id} |
| **NORMAL FORM** | BCNF               |

| **TABLE R03**   | comment |
| --------------  | ------- |
| **Keys**        | {id} |
| **Functional Dependencies:** |
| FD01001          | id → {content_id, news_id, reply_to_id} |
| **NORMAL FORM** | BCNF |

| **TABLE R09**   | request |
| --------------  | --- |
| **Keys**        | {id} |
| **Functional Dependencies:** |
| FD0601          | id → {from_id, reason} |
| **NORMAL FORM** | BCNF |

| **TABLE R10**   | status |
| --------------  | --- |
| **Keys**        | {id} |
| **Functional Dependencies:** |
| FD0701          | id → {request_id, moderator_id, value, date} |
| **NORMAL FORM** | BCNF               |

| **TABLE R11**   | report_user |
| --------------  | --- |
| **Keys**        | {id} |
| **Functional Dependencies:** |
| FD01301          | id → {request_id, date, to_id} |
| **NORMAL FORM** | BCNF               |

| **TABLE R12**   | report_content |
| --------------  | --- |
| **Keys**        | {id} |
| **Functional Dependencies:** |
| FD01401          | id → {request_id, date, to_id} |
| **NORMAL FORM** | BCNF               |

| **TABLE R13**   | partner_request |
| --------------  | --- |
| **Keys**        | {id} |
| **Functional Dependencies:** |
| FD01501          | id → {request_id, date} |
| **NORMAL FORM** | BCNF |

| **TABLE R14**   | unban_appeal |
| --------------  | --- |
| **Keys**        | {id} |
| **Functional Dependencies:** |
| FD01601          | id → {request_id, ban_id, date} |
| **NORMAL FORM** | BCNF |

| **TABLE R16**   | vote |
| --------------  | --- |
| **Keys**        | {id} |
| **Functional Dependencies:** |
| FD0401          | id → {user_id, content_id, value} |
| **NORMAL FORM** | BCNF |

| **TABLE R15**   | notification |
| --------------  | --- |
| **Keys**        | {id} |
| **Functional Dependencies:**  |
| FD0301          | id → {user_id, vote_id, comment_id, is_new} |
| **NORMAL FORM** | BCNF |

| **TABLE R17**   | faq |
| --------------  | --- |
| **Keys**        | {id}, {question} |
| **Functional Dependencies:** |
| FD0801          | id → {question, answer} |
| FD0802          | question → {answer} |
| **NORMAL FORM** | BCNF |

Since all relations are in the Boyce-Codd Normal Form (BCNF), the relational schema is also in BCNF and therefore there is no need to be defined using normalisation.  


### 4. SQL Code

```sql
DROP TABLE IF EXISTS "faq" CASCADE;
DROP TABLE IF EXISTS "vote" CASCADE;
DROP TABLE IF EXISTS "notification" CASCADE;
DROP TABLE IF EXISTS "unban_appeal" CASCADE;
DROP TABLE IF EXISTS "partner_request" CASCADE;
DROP TABLE IF EXISTS "report_content" CASCADE;
DROP TABLE IF EXISTS "report_user" CASCADE; 
DROP TABLE IF EXISTS "request" CASCADE;
DROP TABLE IF EXISTS "news_tag" CASCADE;
DROP TABLE IF EXISTS "news" CASCADE;
DROP TABLE IF EXISTS "tag" CASCADE;
DROP TABLE IF EXISTS "ban" CASCADE;
DROP TABLE IF EXISTS "content" CASCADE;
DROP TABLE IF EXISTS "comment" CASCADE;
DROP TABLE IF EXISTS "follow" CASCADE;
DROP TABLE IF EXISTS "user" CASCADE;

DROP TYPE IF EXISTS GENDER_TYPE CASCADE;
DROP TYPE IF EXISTS STATUS_TYPE CASCADE;

CREATE TYPE GENDER_TYPE AS ENUM('m','f','n');
CREATE TYPE STATUS_TYPE AS ENUM('aproved', 'rejected');

CREATE TABLE "user"(
    id GENERATED ALWAYS AS IDENTITY,
    email TEXT NOT NULL UNIQUE,
    password TEXT NOT NULL,
    description TEXT,
    photo TEXT,
    birthdate DATE NOT NULL,
    gender GENDER_TYPE NOT NULL,
    reputation INTEGER NOT NULL DEFAULT 0 CHECK (reputation >=0) ,
    is_moderator BOOLEAN NOT NULL DEFAULT false,
    is_partner BOOLEAN NOT NULL DEFAULT false,
    is_banned BOOLEAN NOT NULL DEFAULT false,
    is_deleted BOOLEAN NOT NULL DEFALT false,
    PRIMARY KEY(id)
);

CREATE TABLE "follow"(
    id GENERATED ALWAYS AS IDENTITY,
    follower_id INTEGER NOT NULL,
    user_id INTEGER NOT NULL,
    PRIMARY KEY(id),
    CONSTRAINT fk_follower_id
        FOREIGN KEY(follower_id) 
            REFERENCES "user"(id)
            ON DELETE CASCADE,
    CONSTRAINT fk_user_id
        FOREIGN KEY(user_id) 
            REFERENCES "user"(id)
            ON DELETE CASCADE,
);

CREATE TABLE "ban"(
    id GENERATED ALWAYS AS IDENTITY,
    start timestamp WITH TIME ZONE DEFAULT now() NOT NULL,
    "end" timestamp DEFAULT NULL,
    reason TEXT,
    moderator_id INTEGER NOT NULL, /*CHECK user.is_moderator == true with triggers*/
    user_id INTEGER NOT NULL,
    PRIMARY KEY(id),
    CONSTRAINT fk_moderator_id
        FOREIGN KEY(moderator_id) 
            REFERENCES "user"(id)
            ON DELETE CASCADE,
     CONSTRAINT fk_user_id
        FOREIGN KEY(user_id) 
	        REFERENCES "user"(id)
	        ON DELETE CASCADE
        
);

CREATE TABLE "content" (
    id GENERATED ALWAYS AS IDENTITY,
    author_id INTEGER NOT NULL,
    body TEXT NOT NULL,
    "date" TIMESTAMP WITH TIME ZONE DEFAULT now() NOT NULL,
    PRIMARY KEY(id),
    CONSTRAINT fk_author_id
        FOREIGN KEY(author_id) 
	        REFERENCES "user"(id)
	        ON DELETE CASCADE
);

CREATE TABLE "tag" (
    id GENERATED ALWAYS AS IDENTITY,
    "name" TEXT NOT NULL UNIQUE,
    PRIMARY KEY(id)
);

CREATE TABLE "news" (
    id GENERATED ALWAYS AS IDENTITY,
    content_id INTEGER NOT NULL,
    title TEXT NOT NULL,
    trending_score INTEGER CHECK (trending_score >= 0),
    PRIMARY KEY(id),
    CONSTRAINT fk_content_id
        FOREIGN KEY(content_id) 
	        REFERENCES "content"(id)
	        ON DELETE CASCADE
    
);

CREATE TABLE "news_tag" (
    news_id INTEGER,
    tag_id INTEGER,
    PRIMARY KEY(news_id, tag_id),
    CONSTRAINT fk_news_id
        FOREIGN KEY(news_id) 
	        REFERENCES "news"(id)
	        ON DELETE CASCADE,
    CONSTRAINT fk_tag_id
        FOREIGN KEY(tag_id) 
	        REFERENCES "tag"(id)
	        ON DELETE CASCADE
);

CREATE TABLE "comment" (
    id GENERATED ALWAYS AS IDENTITY,
    content_id INTEGER NOT NULL REFERENCES "content" (id) ON UPDATE CASCADE,
    news_id INTEGER NOT NULL REFERENCES "news" (id) ON UPDATE CASCADE,
    reply_to_id INTEGER REFERENCES "comment" (id) ON UPDATE CASCADE,
    PRIMARY KEY(id),
    CONSTRAINT fk_content_id
        FOREIGN KEY(content_id) 
	        REFERENCES "content"(id)
	        ON DELETE CASCADE,
    CONSTRAINT fk_news_id
        FOREIGN KEY(news_id) 
	        REFERENCES "news"(id)
	        ON DELETE CASCADE,
    CONSTRAINT fk_reply_to_id
        FOREIGN KEY(reply_to_id) 
	        REFERENCES "comment"(id)
	        ON DELETE CASCADE
);

CREATE TABLE "request" (
   id GENERATED ALWAYS AS IDENTITY,
   from_id INTEGER NOT NULL,
   moderator_id INTEGER NOT NULL, /* CHECK moderator_id.is_moderator == true WITH TRIGGERS*/
   reason TEXT NOT NULL,
   creation_date TIMESTAMP WITH TIME ZONE DEFAULT now() NOT NULL,
   "status" STATUS_TYPE,
   revision_date TIMESTAMP WITH TIME ZONE,
   PRIMARY KEY(id),
   CONSTRAINT fk_from_id
        FOREIGN KEY(from_id) 
	        REFERENCES "user"(id)
	        ON DELETE CASCADE,
    CONSTRAINT fk_moderator_id
        FOREIGN KEY(moderator_id) 
	        REFERENCES "user"(id)
	        ON DELETE CASCADE
); 

CREATE TABLE "report_user" (
    request_id INTEGER NOT NULL,
    to_user_id INTEGER NOT NULL,
    PRIMARY KEY(request_id),
    CONSTRAINT fk_request_id
        FOREIGN KEY(request_id) 
	        REFERENCES "request"(id)
	        ON DELETE CASCADE,
    CONSTRAINT fk_to_user_id
        FOREIGN KEY(to_user_id) 
	        REFERENCES "user"(id)
	        ON DELETE CASCADE
);

CREATE TABLE "report_content" (
    request_id INTEGER NOT NULL,
    to_content_id INTEGER NOT NULL,
    PRIMARY KEY(request_id),
    CONSTRAINT fk_request_id
        FOREIGN KEY(request_id) 
	        REFERENCES "request"(id)
	        ON DELETE CASCADE,
    CONSTRAINT fk_to_content_id
        FOREIGN KEY(to_content_id) 
	        REFERENCES "content"(id)
	        ON DELETE CASCADE
);

CREATE TABLE "partner_request" (
    request_id INTEGER NOT NULL,
    PRIMARY KEY(request_id),
    CONSTRAINT fk_request_id
        FOREIGN KEY(request_id) 
	        REFERENCES "request"(id)
	        ON DELETE CASCADE
);

CREATE TABLE "unban_appeal" (
    request_id INTEGER NOT NULL,
    ban_id INTEGER NOT NULL,
    PRIMARY KEY(request_id),
    CONSTRAINT fk_request_id
        FOREIGN KEY(request_id) 
	        REFERENCES "request"(id)
	        ON DELETE CASCADE,
    CONSTRAINT fk_ban_id
        FOREIGN KEY(ban_id) 
	        REFERENCES "ban"(id)
	        ON DELETE CASCADE
);

CREATE TABLE "vote" (
    user_id INTEGER,
    content_id INTEGER, /*CHECK content.author_id != user_id */
    value INTEGER NOT NULL,
    PRIMARY KEY(user_id, content_id),
    CONSTRAINT fk_user_id
        FOREIGN KEY(user_id) 
	        REFERENCES "user"(id)
	        ON DELETE CASCADE,
    CONSTRAINT fk_content_id
        FOREIGN KEY(content_id) 
	        REFERENCES "content"(id)
	        ON DELETE CASCADE
);

CREATE TABLE "notification" ( /*not done, will change to composition*/
    id GENERATED ALWAYS AS IDENTITY,
    user_id INTEGER NOT NULL REFERENCES "user" (id) ON UPDATE CASCADE,
    vote_id INTEGER NOT NULL REFERENCES "vote" (id) ON UPDATE CASCADE,
    comment_id INTEGER NOT NULL REFERENCES "comment" (id) ON UPDATE CASCADE,
    is_new BOOLEAN DEFAULT true,
    CHECK (vote_id IS NULL) != (comment_id IS NULL),
    PRIMARY KEY(id),
);


CREATE TABLE "faq" (
    id GENERATED ALWAYS AS IDENTITY,
    question TEXT NOT NULL UNIQUE,
    answer TEXT NOT NULL,
    PRIMARY KEY(id)
);
```
